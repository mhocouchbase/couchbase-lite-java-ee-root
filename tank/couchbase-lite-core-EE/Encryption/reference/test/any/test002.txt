/*
** Run this script using an SEE-enabled shell.
**
**    see <test001.txt
*/

/* Verify that a --textkey of xyzzy generates an appropriate hash key */
.open -new -textkey aes256:xyzzy test.db
CREATE TABLE t1(x);
           /*  a e s 2 5 6 : */
.open -hexkey 6165733235363aae62f1cd14879f114c29ee890cc499113231ab47f64bd736143e35fa80185179 test.db
.testcase 100
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t1(x); ok"

.open --textkey aes256:xyzzy test.db
.testcase 110
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t1(x); ok"

/* A single-bit change in the -textkey results in a very different hash */
.open -new -textkey aes256:xyzzx test.db
CREATE TABLE t1(x);
           /*  a e s 2 5 6 : */
.open -hexkey 6165733235363aa0cd802244e2cd9affb8bd7eb40c77fb0ad24a39e3743981f672ee64b2c00599 test.db
.testcase 200
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t1(x); ok"
.testcase 201
.open -textkey aes256:xyzzx test.db
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t1(x); ok"

/* Verify that --key of xyzzY generates a repeated of the key */
.open -new -key aes256:xyzzY test.db
CREATE TABLE t2(y);
.testcase 210
.open -key aes256:xyzzY test.db
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t2(y); ok"
           /*  a e s 2 5 6 : */
.open -hexkey 6165733235363a78797a7a5978797a7a5978797a7a5978797a7a5978797a7a5978797a7a597879 test.db
.testcase 211
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t2(y); ok"
.testcase 212
         /*  a e s 2 5 6 : */
.text-rekey 6165733235363a78797a7a5978797a7a5978797a7a5978797a7a5978797a7a5978797a7a597879 aes256:xyzzy aes256:xyzzy
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t2(y); ok"

/* After changing the key, log in again. */
.open -textkey aes256:xyzzy test.db
.testcase 230
.schema
PRAGMA integrity_check;
.check "CREATE TABLE t2(y); ok"

/* ATTACH the database using a blob key */
.open :memory:
.testcase 300
                           /*  a e s 2 5 6 : */
ATTACH 'test.db' AS see KEY x'6165733235363aae62f1cd14879f114c29ee890cc499113231ab47f64bd736143e35fa80185179';
SELECT sql FROM see.sqlite_master;
PRAGMA see.integrity_check;
.check "CREATE TABLE t2(y) ok"

/* The correct textkey is copied from the main database connection
** into attachments, if no KEY phrase is specified. */
.testcase 400
.open --new --textkey aes256:xyzzy second.db
CREATE TABLE second(x,y,z);
ATTACH 'test.db' AS orig;
SELECT sql FROM orig.sqlite_master;
PRAGMA orig.integrity_check;
.check "CREATE TABLE t2(y) ok"
